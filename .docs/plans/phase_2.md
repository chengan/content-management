# 第二阶段：自动化内容采集 - 详细开发计划

## 🎯 开发目标
实现微信平台的真实内容采集功能，集成今日热榜API，建立完整的采集、去重、存储流程。

## 📊 项目现状分析

**✅ 已完成功能：**
- 素材管理的完整后端API和前端页面
- Supabase数据库集成和操作封装
- 采集页面的UI界面（使用模拟数据）
- 完整的API客户端架构

**❌ 存在问题：**
1. 采集功能只有前端界面，没有真实的API对接
2. 缺少今日热榜API的具体实现
3. 数据库缺少采集相关的表结构
4. 环境变量配置不完整

**🎯 用户需求：**
- 第一阶段只要微信平台数据
- 微信热文总榜hashid：WnBe01o371
- 保持与素材管理功能的风格统一

## 📋 详细开发任务清单

### 1️⃣ 基础配置和环境搭建

**Task 1.1 - 配置今日热榜API环境变量**
- [x] 在.env.local中添加TOPHUB_ACCESS_KEY
- [x] 更新环境变量文档说明
- [x] 验证API key的有效性

**Task 1.2 - 创建今日热榜API客户端**
- [x] 创建 `/lib/tophub.ts` 封装今日热榜API调用
- [x] 实现 getAllNodes, getNodeDetail, searchNodeContent 方法  
- [x] 添加错误处理和重试机制
- [x] 添加请求频率限制保护
- [x] 创建 `/api/test-tophub` 测试接口并验证通过

### 2️⃣ 数据库扩展

**Task 2.1 - 创建采集相关数据库表**
- [x] 设计collect_sources表结构（采集源配置表）
- [x] 设计collect_history表结构（采集历史表）  
- [x] 创建必要的索引优化查询性能
- [x] 插入微信平台初始数据
- [x] 编写详细的数据库创建操作教程

**Task 2.2 - 扩展Supabase服务**
- [x] 在 `/lib/supabase.ts` 中添加采集相关的数据操作方法
- [x] 实现采集历史的增删改查
- [x] 添加数据转换函数（数据库格式↔前端格式）
- [x] 添加采集源的管理方法（CRUD操作）
- [x] 添加采集统计数据查询方法
- [x] 添加文章去重检查功能
- [x] 添加批量文章创建方法
- [x] 完善TypeScript类型定义（CollectSource、CollectHistory、CollectStats等）

### 3️⃣ 后端API开发

**Task 3.1 - 创建 `/api/collect/sources` 接口**
- [x] GET: 获取微信平台的所有子类目列表
- [x] 实现数据缓存机制（避免频繁调用今日热榜API）
- [x] 添加参数验证和错误处理
- [x] 保持与materials API相同的响应格式

**Task 3.2 - 创建 `/api/collect/hotlist` 接口**
- [x] GET: 获取微信热文总榜实时内容（hashid: WnBe01o371）
- [x] 支持分页和数量限制参数
- [x] 集成内容质量筛选
- [x] 添加数据格式转换（适配Article类型）

**Task 3.3 - 创建 `/api/collect/articles` 接口**
- [x] POST: 手动采集指定文章到素材库
- [x] 实现去重逻辑（基于标题+来源URL）
- [x] 自动设置文章状态为pending
- [x] 支持批量采集操作

**Task 3.4 - 创建 `/api/collect/history` 接口**
- [x] GET: 查看采集历史记录和统计数据
- [x] 支持按时间范围和平台筛选
- [x] 返回采集成功率统计
- [x] 支持分页查询

### 4️⃣ 前端功能改造

**Task 4.1 - 扩展API客户端**
- [x] 在 `/lib/api.ts` 中添加采集相关的API方法
- [x] 保持与materialsApi相同的风格和错误处理
- [x] 添加类型定义和接口声明
- [x] 创建 collectApi 对象封装所有采集方法

**Task 4.2 - 改造采集页面 (`/app/collect/page.tsx`)**
- [x] 替换模拟数据调用为真实API
- [x] 优化微信平台的子类目选择UI
- [x] 添加采集历史查看功能
- [x] 改进错误提示和加载状态

**Task 4.3 - 集成采集到素材库**
- [x] 完善采集结果与素材库的数据流转
- [x] 添加批量采集成功提示
- [x] 实现采集数据的实时同步
- [x] 更新AppContext中的状态管理

### 5️⃣ 数据处理和优化

**Task 5.1 - 实现内容去重机制**
- [ ] 基于标题和URL的智能去重
- [ ] 添加重复内容的提示信息
- [ ] 实现去重统计显示
- [ ] 提供手动选择保留策略

**Task 5.2 - 内容质量筛选**
- [ ] 过滤太短或无意义的内容（标题长度、内容长度）
- [ ] 添加基础的内容质量评分
- [ ] 过滤广告和推广内容
- [ ] 保留高质量内容的优先级

**Task 5.3 - 错误处理和日志**
- [ ] 完善API调用的错误处理
- [ ] 添加采集失败的重试机制
- [ ] 记录采集操作日志
- [ ] 添加网络超时和限流处理

### 6️⃣ 测试和验证

**Task 6.1 - API接口测试**
- [ ] 测试所有采集相关API的正常流程
- [ ] 验证错误情况的处理
- [ ] 测试并发采集的稳定性
- [ ] 验证数据格式的正确性

**Task 6.2 - 前端功能测试**
- [ ] 测试微信平台内容采集的完整流程
- [ ] 验证与素材库的数据同步
- [ ] 测试UI交互的流畅性
- [ ] 验证错误提示的准确性

**Task 6.3 - 数据完整性验证**
- [ ] 检查采集数据的完整性和准确性
- [ ] 验证去重机制的有效性
- [ ] 测试大量数据采集的性能
- [ ] 验证采集历史记录的准确性

## 🗂️ 文件结构规划

```
├── lib/
│   ├── tophub.ts                    # 今日热榜API客户端
│   ├── api.ts                       # 扩展API客户端（添加采集方法）
│   └── supabase.ts                  # 扩展Supabase服务
├── app/api/collect/
│   ├── sources/route.ts             # 采集源API
│   ├── hotlist/route.ts             # 热榜内容API
│   ├── articles/route.ts            # 文章采集API
│   └── history/route.ts             # 采集历史API
├── app/collect/
│   └── page.tsx                     # 改造采集页面
└── src/types/
    └── index.ts                     # 添加采集相关类型定义
```

## 🛠️ 技术实施细节

### 环境变量配置
```env
# 今日热榜API配置
TOPHUB_ACCESS_KEY=your-tophub-access-key
```

### 核心API调用示例
```typescript
// 获取微信热文总榜
const hotlist = await getNodeDetail('WnBe01o371');

// 批量采集文章
const articles = await collectApi.batchCollect(selectedArticles);
```

### 数据流转流程
1. 用户选择采集参数 → 调用hotlist API获取文章列表
2. 用户选择要采集的文章 → 调用articles API保存到素材库
3. 系统记录采集历史 → 更新统计数据
4. 前端同步更新 → 显示采集结果

## ⏱️ 开发时间估算

- **第1-2项任务**：0.5天（配置和基础架构）
- **第3项任务**：1.5天（4个后端API开发）
- **第4项任务**：1天（前端改造）
- **第5-6项任务**：1天（优化和测试）
- **总计**：4天

## 🎉 完成标准

- ✅ 能够成功获取微信热文总榜的真实数据
- ✅ 采集的文章能够正确保存到素材库
- ✅ 采集历史和统计数据准确记录
- ✅ 去重机制有效工作
- ✅ 前端界面与素材管理功能风格统一
- ✅ 所有API接口正常工作且有完善的错误处理

## 📝 后续优化方向

1. **多平台支持**：在第三阶段扩展到知乎、微博等平台
2. **定时采集**：添加定时任务功能，自动采集热门内容
3. **智能筛选**：基于AI的内容质量评估和自动分类
4. **采集策略**：支持关键词采集和个性化内容推荐

---

*此计划将确保第二阶段功能与现有素材管理系统完美整合，为后续AI改写功能奠定坚实基础。*